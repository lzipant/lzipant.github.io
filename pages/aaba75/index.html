<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Java中String的存储 | harrison&#39;s blog</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="后端技术博客,简洁至上,专注Java学习与总结。Java, Spring, SpringBoot, SpringCloud, MyBatis, Netty, RabbitMQ, Kafka, Dubbo, Linux, Linux Kernel等技术文章。">
    <meta name="keywords" content="后端技术博客">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="preload" href="/assets/css/0.styles.db69af13.css" as="style"><link rel="preload" href="/assets/js/app.36e91a11.js" as="script"><link rel="preload" href="/assets/js/2.409e0185.js" as="script"><link rel="preload" href="/assets/js/6.feb75664.js" as="script"><link rel="prefetch" href="/assets/js/10.1206fbe6.js"><link rel="prefetch" href="/assets/js/11.811b7408.js"><link rel="prefetch" href="/assets/js/12.83e62cf0.js"><link rel="prefetch" href="/assets/js/13.3da6fa14.js"><link rel="prefetch" href="/assets/js/14.be23cced.js"><link rel="prefetch" href="/assets/js/15.5b1701fd.js"><link rel="prefetch" href="/assets/js/16.3d55b70f.js"><link rel="prefetch" href="/assets/js/17.7429b142.js"><link rel="prefetch" href="/assets/js/18.796642e8.js"><link rel="prefetch" href="/assets/js/19.ffb2f3b3.js"><link rel="prefetch" href="/assets/js/20.9b77edb3.js"><link rel="prefetch" href="/assets/js/21.45f0bd1c.js"><link rel="prefetch" href="/assets/js/22.05843092.js"><link rel="prefetch" href="/assets/js/23.99984d12.js"><link rel="prefetch" href="/assets/js/24.6a89fd33.js"><link rel="prefetch" href="/assets/js/25.16160e78.js"><link rel="prefetch" href="/assets/js/26.471a561c.js"><link rel="prefetch" href="/assets/js/27.ff9b36a8.js"><link rel="prefetch" href="/assets/js/28.d235529f.js"><link rel="prefetch" href="/assets/js/29.ac8ca018.js"><link rel="prefetch" href="/assets/js/3.1c6d2763.js"><link rel="prefetch" href="/assets/js/30.96538408.js"><link rel="prefetch" href="/assets/js/31.47118b60.js"><link rel="prefetch" href="/assets/js/32.fb74aca4.js"><link rel="prefetch" href="/assets/js/33.d059016b.js"><link rel="prefetch" href="/assets/js/34.c1f0aff0.js"><link rel="prefetch" href="/assets/js/35.1b63946e.js"><link rel="prefetch" href="/assets/js/36.305c9ab9.js"><link rel="prefetch" href="/assets/js/37.1f8690b8.js"><link rel="prefetch" href="/assets/js/38.6a0faec0.js"><link rel="prefetch" href="/assets/js/39.6a4f34cc.js"><link rel="prefetch" href="/assets/js/4.f0a8c30f.js"><link rel="prefetch" href="/assets/js/40.2d767369.js"><link rel="prefetch" href="/assets/js/41.f6602ec0.js"><link rel="prefetch" href="/assets/js/42.d86dc81f.js"><link rel="prefetch" href="/assets/js/43.3193e48c.js"><link rel="prefetch" href="/assets/js/44.ba2bfbed.js"><link rel="prefetch" href="/assets/js/45.c855ea02.js"><link rel="prefetch" href="/assets/js/46.cc0695f3.js"><link rel="prefetch" href="/assets/js/47.9356ab33.js"><link rel="prefetch" href="/assets/js/48.04ed80cc.js"><link rel="prefetch" href="/assets/js/49.3b625cf2.js"><link rel="prefetch" href="/assets/js/5.e688792f.js"><link rel="prefetch" href="/assets/js/50.45f22e5f.js"><link rel="prefetch" href="/assets/js/51.e28308a2.js"><link rel="prefetch" href="/assets/js/52.2d74a9f7.js"><link rel="prefetch" href="/assets/js/53.9ea65ca6.js"><link rel="prefetch" href="/assets/js/54.b92ef08c.js"><link rel="prefetch" href="/assets/js/55.c96f6cd9.js"><link rel="prefetch" href="/assets/js/56.66e76778.js"><link rel="prefetch" href="/assets/js/57.290715f8.js"><link rel="prefetch" href="/assets/js/58.68f33ada.js"><link rel="prefetch" href="/assets/js/59.a0c46087.js"><link rel="prefetch" href="/assets/js/60.942b9285.js"><link rel="prefetch" href="/assets/js/7.3e34b1bc.js"><link rel="prefetch" href="/assets/js/8.e4dd00a2.js"><link rel="prefetch" href="/assets/js/9.74704eea.js">
    <link rel="stylesheet" href="/assets/css/0.styles.db69af13.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/HL-logo.png" alt="harrison's blog" class="logo"> <span class="site-name can-hide">harrison's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分类</a></div><div class="nav-item"><a href="/tags/" class="nav-link">标签</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="收藏" class="dropdown-title"><!----> <span class="title" style="display:;">收藏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/collections/websites/" class="nav-link">网站</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://cdn.jsdelivr.net/gh/HarrisonLee1998/image/avatar.jpg"> <div class="blogger-info"><h3>Harrison Lee</h3> <span>玻璃晴朗，橘子辉煌</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/categories/" class="nav-link">分类</a></div><div class="nav-item"><a href="/tags/" class="nav-link">标签</a></div><div class="nav-item"><a href="/archives/" class="nav-link">归档</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="收藏" class="dropdown-title"><!----> <span class="title" style="display:;">收藏</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/collections/websites/" class="nav-link">网站</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>基础</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/aaba75/" aria-current="page" class="active sidebar-link">Java中String的存储</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/aaba75/#有哪些常量池" class="sidebar-link">有哪些常量池</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/aaba75/#class常量池（class-constant-pool）" class="sidebar-link">class常量池（Class Constant Pool）</a></li><li class="sidebar-sub-header"><a href="/pages/aaba75/#运行时常量池（runtime-constant-pool）" class="sidebar-link">运行时常量池（Runtime Constant Pool）</a></li><li class="sidebar-sub-header"><a href="/pages/aaba75/#字符串常量池" class="sidebar-link">字符串常量池</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/aaba75/#字符串字面量什么时候进入字符串常量池" class="sidebar-link">字符串字面量什么时候进入字符串常量池</a></li><li class="sidebar-sub-header"><a href="/pages/aaba75/#string的定义方式" class="sidebar-link">String的定义方式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/aaba75/#第一种方式" class="sidebar-link">第一种方式</a></li><li class="sidebar-sub-header"><a href="/pages/aaba75/#第二种方式" class="sidebar-link">第二种方式</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/aaba75/#字符串的拼接" class="sidebar-link">字符串的拼接</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/aaba75/#concat-拼接" class="sidebar-link">concat()拼接</a></li><li class="sidebar-sub-header"><a href="/pages/aaba75/#运算符拼接" class="sidebar-link">运算符拼接</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/aaba75/#intern-方法" class="sidebar-link">intern()方法</a></li><li class="sidebar-sub-header"><a href="/pages/aaba75/#参考" class="sidebar-link">参考</a></li></ul></li><li><a href="/pages/39d636/" class="sidebar-link">Java中的内部类</a></li><li><a href="/pages/6cec3e/" class="sidebar-link">Java中的代理</a></li><li><a href="/pages/95a02e/" class="sidebar-link">Java中的日志体系概述</a></li><li><a href="/pages/b725c0/" class="sidebar-link">Java8新日期API</a></li><li><a href="/pages/405394/" class="sidebar-link">Java中的枚举</a></li><li><a href="/pages/226a87/" class="sidebar-link">Java中的Lambda表达式及原理</a></li><li><a href="/pages/6ff86f/" class="sidebar-link">Java中的方法句柄</a></li><li><a href="/pages/0a8d09/" class="sidebar-link">Java中的反射</a></li><li><a href="/pages/72f0d2/" class="sidebar-link">Java中的强软弱虚引用</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>集合</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>线程与并发</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>JVM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>JDBC</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper bg-style-1"><div class="articleInfo-wrap" data-v-33863c7e><div class="articleInfo" data-v-33863c7e><ul class="breadcrumbs" data-v-33863c7e><li data-v-33863c7e><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-33863c7e></a></li> <li data-v-33863c7e><a href="/categories/?category=%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80" title="分类" data-v-33863c7e>编程语言</a></li> <li data-v-33863c7e><a href="/categories/?category=Java" title="分类" data-v-33863c7e>Java</a></li> <li data-v-33863c7e><a href="/categories/?category=%E5%9F%BA%E7%A1%80" title="分类" data-v-33863c7e>基础</a></li></ul> <div class="info" data-v-33863c7e><div title="作者" class="author iconfont icon-touxiang" data-v-33863c7e><a href="https://github.com/HarrisonLee1998" target="_blank" title="作者" class="beLink" data-v-33863c7e>Harrison Lee</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-33863c7e><a href="javascript:;" data-v-33863c7e>2020-06-27</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">
          Java中String的存储
        </h1> <!----> <div class="theme-vdoing-content content__default"><p>String的存储可能不是那么地直观，有些机制可能会违背我们的直觉。但是，这一问题又是面试的高频问题，同时理解好String的存储更有利于我们在写代码时更有底气。</p> <h2 id="有哪些常量池"><a href="#有哪些常量池" class="header-anchor">#</a> 有哪些常量池</h2> <h3 id="class常量池（class-constant-pool）"><a href="#class常量池（class-constant-pool）" class="header-anchor">#</a> class常量池（Class Constant Pool）</h3> <p>Java的class文件中有一部分称作为常量池，包含字面量（literal）和符号引用（Symbolic Reference）。对于class文件可以使用javap命令查看class常量池的具体细节。可以发现，<strong>CONSTANT_Utf8_info</strong>类型的常量可以表示文件中所有的标识符、字符串字面量等。</p> <h3 id="运行时常量池（runtime-constant-pool）"><a href="#运行时常量池（runtime-constant-pool）" class="header-anchor">#</a> 运行时常量池（Runtime Constant Pool）</h3> <p>在类加载后，class常量池中的内容将被加载到运行时常量池。方法区是JVM所要求的运行时数据区的一部分，但是不同的虚拟机对此有不同的实现，比如HotSpot早期（JDK8以前）就利用了**永久代（Permanent Generation）**来实现方法区。但由于种种原因，Hotsport于JDK6开始就逐步废弃永久代；到了JDK7时，已经把字符串常量池，静态变量等移除了；到了JDK8，把永久代的剩余内容转移到了元空间(Metaspace）中。运行时常量池属于方法区，但是JVM并没有要求方法区位于内存的哪一部分。Hotspot在废弃永久代后，采用本地内存（native memory）来实现方法区（即Metaspace所处的位置）。</p> <h3 id="字符串常量池"><a href="#字符串常量池" class="header-anchor">#</a> 字符串常量池</h3> <p>因为Java中<code>String</code>类型的值都是不会变化的，采用字符串常量池可以提高性能和减少内存开销，因为当多个<code>String</code>引用指向的<code>String</code>值相等时，只需要保存一份值即可，让其他引用都指向这个值。当需要修改时，然后再拷贝一份进行修改（有点像CopyOnWrite的感觉），同样修改后的字符串也是不可更改的，同样存在字符串常量池中供其他<code>String</code>引用所指向。</p> <p>JDK7之后，HotSpot就把字符串常量池从方法区中移出到了堆中，是一个哈希表结构，用于快速判断字符串对象是否已在常量池中。另外需要搞清楚，<strong>字符串常量池中存放的是java.lang.String对象的引用，而非对象本身</strong>，在Java中所有的对象本身以及数组对象都保存在堆中。</p> <h2 id="字符串字面量什么时候进入字符串常量池"><a href="#字符串字面量什么时候进入字符串常量池" class="header-anchor">#</a> 字符串字面量什么时候进入字符串常量池</h2> <p>Java中的class文件中的常量池中有两类常量：<code>CONSTANT_Utf8_info</code>和<code>CONSTANT_String_info</code>。前者存储真正的字符串内容，后者表示一个<code>java.lang.String</code>对象，存储的是前者类型的索引。</p> <p>就HotSpot的实现来说，在类加载时，class中的常量池的内容进入了内存形成了运行时常量池。这些<code>CONSTANT_Utf8_info</code>只是简单地存储到运行时常量池中，但是不会在堆中创建对象（注意对象和简单地字符串值还是有区别的，对象除了包括值，还有其他相关属性），也不会保存到全局的字符串常量池中，这被称为类加载阶段的懒解析。</p> <p>JVM中的ldc指令用于将int，float或String型常量值从常量池中推送至栈顶。前面讲到懒解析，ldc指令就是触发这个解析操作的。首先，通过<code>CONSTANT_String_info</code>中保存的<code>CONSTANT_Utf8_info</code>类型常量的索引找到对应的项，如果该项没有解析则进行解析，解析时涉及对象的创建，具体创建几个对象与<code>String</code>对象的定义方式有关，请参考下一节。</p> <h2 id="string的定义方式"><a href="#string的定义方式" class="header-anchor">#</a> String的定义方式</h2> <p>Java程序员都知道如下两种字符串的定义方式：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token string">&quot;harrison&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 第一种方式</span>
<span class="token class-name">String</span> s2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;lee&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第二种方式</span>
<span class="token class-name">String</span> s3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;harrison&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="第一种方式"><a href="#第一种方式" class="header-anchor">#</a> 第一种方式</h3> <p>使用第一种方式时，JVM会去字符串常量池中找有没有值和当前字符串字面量相等的对象的引用。如果存在，则直接返回（创建0个对象）；如果不存在，则创建新对象，并把新对象的引用保存到字符串常量池中并返回（创建1个对象）。如下图所示：</p> <p><img src="https://cdn.harrisonlee.net/image-20210122145418130.png" alt="image-20210122145418130"></p> <h3 id="第二种方式"><a href="#第二种方式" class="header-anchor">#</a> 第二种方式</h3> <p>使用第二种方式时，JVM同样会去找字符串常量池中有没有和当前字符串字面量相等的对象的引用。如果存在，则只管创建当前的对象（创建1个对象）；如果不存在，则会创建两个对象，其中1个对象的引用被保存到字符串常量池中，另一个对象的引用返回给变量。如下图所示：</p> <p><img src="https://cdn.harrisonlee.net/image-20210122145515037.png" alt="image-20210122145515037"></p> <div class="custom-block danger"><p class="custom-block-title">警告</p> <p>对于下列代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;harrison&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;lee&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>下面讲字符串拼接时会看到，s1其实也是通过new创建的。但是注意只有“harrison”和“lee”这种字面量保存到了常量池中，“harrisonlee”没有被保存到常量池中，也就是说表达式右边的两个new分别创建了两个对象，但是对于s1，只创建了一个。</p></div> <h2 id="字符串的拼接"><a href="#字符串的拼接" class="header-anchor">#</a> 字符串的拼接</h2> <p>字符串的拼接可以使用运算符<code>+</code>，也可以调用字符串对象的方法<code>concat()</code>。</p> <h3 id="concat-拼接"><a href="#concat-拼接" class="header-anchor">#</a> <code>concat()</code>拼接</h3> <p>如果参数的长度为0，那么将会返回调用者本身。如：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token string">&quot;harrisonlee&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s2 <span class="token operator">=</span> s1<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s1 <span class="token operator">==</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果长度不为0，则通过new的方式创建对象（具体创建几个要看情况）。</p> <h3 id="运算符拼接"><a href="#运算符拼接" class="header-anchor">#</a> 运算符拼接</h3> <p>这部分，在JDK8和JDK11下测试结果不一致<a href="%E7%9B%AE%E5%89%8D%E5%B0%9A%E4%B8%8D%E6%B8%85%E9%99%A4%E6%98%AF%E5%9C%A8%E5%93%AA%E4%B8%AA%E7%89%88%E6%9C%AC%E4%BA%A7%E7%94%9F%E5%8F%98%E5%8C%96%E7%9A%84%E3%80%82">^1</a>。</p> <p>如下列代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token string">&quot;harrison&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s2 <span class="token operator">=</span> <span class="token string">&quot;lee&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s3 <span class="token operator">=</span> s1 <span class="token operator">+</span> s2<span class="token punctuation">;</span>
<span class="token class-name">String</span> s4 <span class="token operator">=</span> <span class="token string">&quot;harrisonlee&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s5 <span class="token operator">=</span> <span class="token string">&quot;harrison&quot;</span> <span class="token operator">+</span> s2<span class="token punctuation">;</span>
<span class="token class-name">String</span> s6 <span class="token operator">=</span> <span class="token string">&quot;harrison&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;lee&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>在JDK8环境下，反编译后的结果如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token string">&quot;harrison&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s2 <span class="token operator">=</span> <span class="token string">&quot;lee&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s4 <span class="token operator">=</span> <span class="token string">&quot;harrisonlee&quot;</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s5 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;harrison&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s6 <span class="token operator">=</span> <span class="token string">&quot;harrisonlee&quot;</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>可见，如果拼接成分中全是字面量，那么编译器直接优化成拼接后的最后结果（如s6），在class常量池中也不存在单个字面量常量（除非在其他地方定义了），节省了字符串常量池的空间。如果拼接成分至少存在一个字符串对象的引用，那么编译器会优化为<code>StringBuilder</code>的方式，并调用<code>append()</code>方法实现拼接，最后的<code>toString()</code>方法内部是通过new方式创建的String对象。</p> <p>在JDK11下，好像使用了与<code>concat()</code>相关的方法来处理。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test01</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">V</span>
    flags<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">0x0001</span><span class="token punctuation">)</span> ACC_PUBLIC
    <span class="token class-name">Code</span><span class="token operator">:</span>
      stack<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span>
         <span class="token number">0</span><span class="token operator">:</span> ldc           #<span class="token number">2</span>                  <span class="token comment">// String harrison</span>
         <span class="token number">2</span><span class="token operator">:</span> astore_1
         <span class="token number">3</span><span class="token operator">:</span> ldc           #<span class="token number">3</span>                  <span class="token comment">// String lee</span>
         <span class="token number">5</span><span class="token operator">:</span> astore_2
         <span class="token number">6</span><span class="token operator">:</span> aload_1
         <span class="token number">7</span><span class="token operator">:</span> aload_2
         <span class="token number">8</span><span class="token operator">:</span> invokedynamic #<span class="token number">4</span><span class="token punctuation">,</span>  <span class="token number">0</span>              <span class="token comment">// InvokeDynamic #0:makeConcatWithConstants:(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;</span>
        <span class="token number">13</span><span class="token operator">:</span> astore_3
        <span class="token number">14</span><span class="token operator">:</span> ldc           #<span class="token number">5</span>                  <span class="token comment">// String harrisonlee</span>
        <span class="token number">16</span><span class="token operator">:</span> astore        <span class="token number">4</span>
        <span class="token number">18</span><span class="token operator">:</span> aload_2
        <span class="token number">19</span><span class="token operator">:</span> invokedynamic #<span class="token number">6</span><span class="token punctuation">,</span>  <span class="token number">0</span>              <span class="token comment">// InvokeDynamic #1:makeConcatWithConstants:(Ljava/lang/String;)Ljava/lang/String;</span>
        <span class="token number">24</span><span class="token operator">:</span> astore        <span class="token number">5</span>
        <span class="token number">26</span><span class="token operator">:</span> ldc           #<span class="token number">5</span>                  <span class="token comment">// String harrisonlee</span>
        <span class="token number">28</span><span class="token operator">:</span> astore        <span class="token number">6</span>
        <span class="token number">30</span><span class="token operator">:</span> <span class="token keyword">return</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>上面第8行和第19行，分别调用了invokedynamic指令。</p> <h2 id="intern-方法"><a href="#intern-方法" class="header-anchor">#</a> <code>intern()</code>方法</h2> <p><code>intern()</code>方法的作用是返回字符串常量池中保存的和当前字符串对象值相等的对象应用。如果存在，则直接返回；如果不存在，在JDK6前后的处理不一样。</p> <p>对于下列代码（假设之前常量池中不存在字符串“harrison”）：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;harrison&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">&quot;lee&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s2 <span class="token operator">=</span> s1<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s1 <span class="token operator">==</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果是在JDK6及其之前，虚拟机的行为是另外新建一个对象，并把该对象的引用保存到字符串常量池中。所以输出false。</p> <p>而如果是在JDK6之后，虚拟机会直接把该对象的引用保存到字符串常量池。所以输出true。JDK6以后<code>intern()</code>的行为明显避免了对象的创建，从而节省了空间。</p> <p>总之一句话就是，<code>intern()</code>方法返回该常量池中与该String对象值相等的被收纳进入常量池中的对象引用。</p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><p><a href="https://javaranch.com/journal/200409/ScjpTipLine-StringsLiterally.html" target="_blank" rel="noopener noreferrer">The SCJP Tip Line  -- Strings, Literally<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p><a href="https://www.zhihu.com/question/55994121" target="_blank" rel="noopener noreferrer">知乎问答：参考用户木女孩的回答以及评论区中R大的留言<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p>《深入理解Java虚拟机（第3版）》</p></li></ul></div></div> <!----> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=Java" title="标签">#Java</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2021-01-22</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><!----> <a href="/pages/39d636/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Java中的内部类</div></a></div> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/pages/39d636/">Java中的内部类</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/0c4c2e/"><div>Spring AOP基础</div></a> <span>02-08</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/e0358f/"><div>SpringBoot中Filter的注册</div></a> <span>02-07</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/226a87/"><div>Java中的Lambda表达式及原理</div></a> <span>01-29</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:lzipant@gmail.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/HarrisonLee1998" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2020-2021
    <span>Harrison Lee | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">跟随系统</li><li class="iconfont icon-rijianmoshi">浅色模式</li><li class="iconfont icon-yejianmoshi">深色模式</li><li class="iconfont icon-yuedu">阅读模式</li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.36e91a11.js" defer></script><script src="/assets/js/2.409e0185.js" defer></script><script src="/assets/js/6.feb75664.js" defer></script>
  </body>
</html>